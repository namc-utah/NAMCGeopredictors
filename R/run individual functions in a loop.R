def_samples = NAMCr::query(
  api_endpoint = "samples",
  include = c("sampleId", "siteId", "sampleDate"),
  projectId=49

)

siteIds=unlist(unique(def_samples$siteId))
def_sites=list()
# for each site in def_predictors get site coordinates and comid from database
# store as a list of lists referenced by "x" plus the siteId
for (t in 1:length(siteIds)){
  if(t==1){
    def_sites= unlist(NAMCr::query(
      api_endpoint = "siteInfo",
      include = c("siteId", "siteName", "usState", "location","waterbodyCode"),
      siteId = siteIds[t]
    ))
  } else {def_sites1= unlist(NAMCr::query(
    api_endpoint = "siteInfo",
    include = c("siteId", "siteName", "usState", "location","waterbodyCode"),
    siteId = siteIds[t]
  ))
  def_sites=as.data.frame(rbind(def_sites,def_sites1))
  }

}
point2process=sf::st_read("C:/Users/jenni/Box/NAMC (Trip Armstrong)/Research Projects/AIM/P_Hab Modeling/Final analyses/modeling/allsites.shp")
point2process=sf::st_transform(point2process,crs=5070)
polygon2process=sf::st_buffer(point2process,1250)
polygon2process=subset(polygon2process,fines_scre!='R')
range=list()



for (s in 1:nrow(polygon2process)){
range[[s]]=VALLEY_ELEV_RANGE(polygon2process[s,])
print(s)
}

bslope=list()
for (s in 6221:nrow(polygon2process)){
  bslope[[s]]=slpavg(polygon2process[s,])
  print(s)
}



lengths3=list()
for (s in 1:702){
  lengths3[[s]]=p_drainage_density(SQLite_file_path,geometry_input_path,geometry_input_name,COMIDs = comids[s])
 }




def_sites=read.csv("C:/Users/jenni/Box/NAMC (Trip Armstrong)/Research Projects/AIM/P_Hab Modeling/Final analyses/modeling/Final AIM results for NOC/AIM_2022_2023_PHAB_pred.csv")
def_sites=sf::st_as_sf(def_sites,coords=c('long','lat'),crs=4269)
lengths3=list()
for (s in 1:nrow(def_sites)){

  lengths3[[s]]=sum_lengthKM(point2process=def_sites[s,],geometry_input_path="C:/Users/jenni/Box/NAMC (Trip Armstrong)/GIS/GIS_Stats/CONUS/streams/NHD_West_str_ord.shp")
}

lengths=list()
for (s in 1:nrow(def_sites)){

  lengths[[s]]=pct_46003(point2process=geojsonsf::geojson_sf(def_sites$location[s]),geometry_input_path="C:/Users/jenni/Box/NAMC (Trip Armstrong)/GIS/GIS_Stats/CONUS/streams/NHD_West_str_ord.shp")
}

lengthsdf=unlist(as.data.frame(cbind(lengths)))


lengths2=list()
for (s in 1:nrow(def_sites)){

  lengths2[[s]]=length_46006(point2process=geojsonsf::geojson_sf(def_sites$location[s]),geometry_input_path="C:/Users/jenni/Box/NAMC (Trip Armstrong)/GIS/GIS_Stats/CONUS/streams/NHD_West_str_ord.shp")
}

lengths2df=as.data.frame(cbind(lengths2))

lengths3=list()
for (s in 1:nrow(def_sites)){

  lengths3[[s]]=sum_lengthKM(point2process=geojsonsf::geojson_sf(def_sites$location[s]),geometry_input_path="C:/Users/jenni/Box/NAMC (Trip Armstrong)/GIS/GIS_Stats/CONUS/streams/NHD_West_str_ord.shp")
}

lengths3df=as.data.frame(cbind(lengths3))

dd2=cbind(lengthsdf,lengths2df,lengths3df)


dd2=cbind(lengthsdf,lengths2df,lengths3df)
def_sites=cbind(def_sites,lengthsdf)
def_sites$siteId=as.numeric(def_sites$siteId)
join=left_join(def_samples,def_sites,by='siteId')
join$length_46003=unlist(join$lengths)
join$length_46006=unlist(join$lengths2)
join$SLOPE=unlist(join$lengths3)

join=join[,c("sampleId","length_46003","length_46006","sum_lengthKM")]
write.csv(join,'density_A1.csv')

lengths4=list()
for (s in 1:nrow(def_sites)){

  lengths4[[s]]=length_A1_3(point2process=geojsonsf::geojson_sf(def_sites$location[s]),geometry_input_path="C:/Users/jenni/Box/NAMC (Trip Armstrong)/GIS/GIS_Stats/CONUS/streams/NHD_West_str_ord_meritt.shp")
}

lengths3df=as.data.frame(cbind(lengths3))

lengths3=list()
for (s in 1:nrow(def_sites)){
tryCatch({lengths3[[s]]=NHDSLOPE(point2process=geojsonsf::geojson_sf(def_sites$location[s]),geometry_input_path="C:/Users/jenni/Box/NAMC (Trip Armstrong)/GIS/GIS_Stats/CONUS/streams/NHD_West_str_ord.shp")
}, error = function(e) {
  cat(paste0("\n\tERROR calculating: ",def_sites$siteId[s],"\n"))
  str(e,indent.str = "   "); cat("\n")
} )
}
DEM_trashbin=tempdir()

polygon2process=sf::st_make_valid(sf::st_read("C:/Users/jenni/Box/NAMC (Trip Armstrong)/Research Projects/AIM/P_Hab Modeling/Final analyses/modeling/watershedsforslope.shp"))
slopel=list()
for (s in 1:nrows(polygon2process)){

  tryCatch({slopel[[s]]=slpavg(polygon2process[s,])
  #unlink(paste0(DEM_trashbin,'/*'))

  }, error = function(e) {
    cat(paste0("\n\tERROR calculating: ",polygon2process[s,],"\n"))
    str(e,indent.str = "   "); cat("\n")
  } )

}
lengths3df=as.data.frame(unlist(as.data.frame(cbind(slopel))))

slopefinal=as.data.frame(cbind(lengths3df,polygon2process$siteId[c(1331:1333,1656,1723:1724,1777:1792)]))
write.csv(slopefinal,"slopepart9.csv")


polygon2process=def_watersheds
wsarea=list()
for (s in 1:nrow(polygon2process)){

  tryCatch({wsarea[[s]]=WSA_SQKM(polygon2process[s,])
  #unlink(paste0(DEM_trashbin,'/*'))

  }, error = function(e) {
    cat(paste0("\n\tERROR calculating: ",polygon2process[s,],"\n"))
    str(e,indent.str = "   "); cat("\n")
  } )

}
lengths3df=as.data.frame(unlist(as.data.frame(cbind(wsarea))))
wsareafinal=as.data.frame(cbind(polygon2process$siteId,wsarea))


comids=c(23520061,
         23532691,
         23227846,
         23498903,
         23185009,
         24075687,
         24072957,
         24072959,
         24075267,
         24073529,
         24013761,
         24072903,
         24074777,
         24013887,
         11300894,
         24014353,
         24014657,
         11844773,
         24014473,
         24013937,
         8949750,
         24042959,
         24013653,
         24014023,
         24013713,
         24013733,
         24013693,
         24013669,
         24013687,
         24013683,
         7951850,
         7952144,
         7952094,
         20451460,
         24013967,
         24013769,
         24057511,
         24013897,
         24075523,
         946060108,
         23442121,
         20266761,
         20266837,
         14918033,
         23284239,
         23284213,
         11277540,
         11281838,
         11281258,
         24003075,
         24003151,
         24013927,
         24007678,
         23413899,
         24003145,
         24003123,
         23414045,
         23414241,
         23415671,
         23414131,
         24073163,
         23185033,
         23187011,
         23186893,
         22047753,
         17053944,
         14992289,
         8257759,
         5360660,
         22106545,
         22106443,
         14599589,
         23499149,
         23479835,
         23479591,
         23499623,
         23500115,
         23498937,
         23479535,
         23238614,
         23482853,
         23481023,
         17906257,
         1320886,
         12801764,
         12801730,
         12803274,
         4429375,
         1234509,
         17497463,
         17029408,
         3181220,
         12801510,
         12801870,
         12812677,
         12801872,
         1254652,
         12803256,
         1237919,
         1254632,
         1254606,
         1238023,
         1253474,
         23599073,
         23598195,
         23560105,
         23560505,
         23542036,
         23570099,
         23599313,
         23569667,
         23541794,
         23598199,
         20310827,
         10772026,
         10771898,
         10772004,
         10772130,
         24219851,
         23184997,
         10683178,
         10683176,
         10682632,
         20052029,
         917603,
         17887098,
         922613,
         17887124,
         17887146,
         916515,
         3253987,
         3255303,
         17886640,
         916519,
         3255211,
         1424028,
         20451366,
         1238033,
         15998840,
         23196240,
         4558716,
         23387311,
         23513704,
         24159945,
         12770867,
         11390644,
         23287029,
         11179295,
         23737725,
         23671143,
         22226490,
         24208825,
         3199328,
         1392379,
         3906307,
         10907263,
         15950196,
         5412291,
         12803838,
         1253522,
         3255235,
         3255301,
         10041210,
         18266123,
         18266075,
         17013745,
         17013795,
         11303924,
         11203698,
         11277302,
         24438964,
         23238752,
         23624584,
         23607156,
         23387503,
         24460270,
         23543184,
         23233821,
         23479809,
         23284447,
         23284431,
         23196032,
         23198320,
         10025682,
         7899661,
         7899933,
         7899509,
         7899533,
         7899467,
         7899771,
         7899817,
         7900617,
         7899415,
         7899887,
         17496175,
         3265352,
         12882898,
         12877320,
         15954062,
         12882552,
         15951086,
         15953528,
         15954724,
         2551907,
         24042633,
         24042935,
         24042943,
         24042631,
         24042967,
         24043371,
         24042941,
         24045997,
         24044549,
         3057710,
         3055744,
         11846087,
         24075611,
         24075629,
         11230154,
         11230236,
         12829298,
         23478369,
         23230517,
         3052756,
         4217172,
         23821997,
         241790,
         12744621,
         18329296,
         23671499,
         18352243,
         23551208,
         4169806,
         3055416,
         24143546,
         11845035,
         24143534,
         14917879,
         23924988,
         23916053,
         23801710,
         23350125,
         23413095,
         9768598,
         4901923,
         3255167,
         15962288,
         4906513,
         3255191,
         1238081,
         3255289,
         15984983,
         17013535,
         3251709,
         24350032,
         12349429,
         9305750,
         9301557,
         4887949,
         4885639,
         4885683,
         11212134,
         11174301,
         11230248,
         19886451,
         11111595,
         11212156,
         11212144,
         10722760,
         17836894,
         10776554,
         18383311,
         17887816,
         17887798,
         918115,
         918071,
         2885324,
         24177215,
         23543688,
         23233267,
         23158094,
         22979310,
         24321422,
         22965192,
         11338657,
         23896078,
         24013601,
         10092450,
         7888216,
         3199284,
         18302986,
         4268798,
         18299718,
         20678531,
         19811083,
         22069944,
         25138958,
         10786460,
         11179241,
         11125321,
         10409530,
         19857940,
         11136532,
         11277572,
         11154499,
         11303966,
         1237229,
         1253708,
         1232859,
         4909812,
         20594430,
         20594334,
         11340311,
         11339583,
         20594520,
         23442233,
         23413133,
         24057153,
         23443735,
         12801504,
         2764512,
         21879769,
         14917925,
         12801588,
         8268309,
         12352275,
         12801512,
         23360755,
         23361903,
         23822003,
         18350347,
         18348987,
         18353393,
         18352783,
         24479771,
         24452741,
         1185029,
         23157400,
         23822047,
         23822603,
         23823879,
         23823501,
         23709985,
         23709035,
         18354241,
         18275539,
         18272060,
         18272094,
         18276279,
         15961744,
         18272102,
         15966765,
         15984981,
         15976206,
         15984971,
         15954886,
         15954910,
         15976224,
         15974942,
         15976210,
         15983871,
         15954978,
         15955220,
         15975910,
         15975208,
         18272658,
         15955242,
         15955258,
         15984619,
         17493835,
         17482171,
         15981181,
         15975946,
         15984979,
         15983933,
         18272122,
         15954982,
         15954972,
         15955252,
         15984353,
         15954974,
         15961684,
         15966605,
         916509,
         4901975,
         4886497,
         4901929,
         5302247,
         4894051,
         4884463,
         20215626,
         18300402,
         15953446,
         15953494,
         15950278,
         21324311,
         21356765,
         15916161,
         15915899,
         21318801,
         15919549,
         15919559,
         15915565,
         23513116,
         23513300,
         23514682,
         23513118,
         23230653,
         23513726,
         23513586,
         23514284,
         23513192,
         23513380,
         23042277,
         23031342,
         8924077,
         10025024,
         20654094,
         10026030,
         22959351,
         23630420,
         24491538,
         24491558,
         23251967,
         23263028,
         24491562,
         24491854,
         9989335,
         20318610,
         24042971,
         20317618,
         20318632,
         9988089,
         17887114,
         10717962,
         24233474,
         10722762,
         8916205,
         3255293,
         3231777,
         1253586,
         3174596,
         18383401,
         17866714,
         20051721,
         20045636,
         8953172,
         18383543,
         18384913,
         17013813,
         17013803,
         18383677,
         21274290,
         15932813,
         18375164,
         1337160,
         23148592,
         23233055,
         23233111,
         23148434,
         23227960,
         23227794,
         23233463,
         23233923,
         23227744,
         10274176,
         10275820,
         10039874,
         11977375,
         3379515,
         10395905,
         3276991,
         24200593,
         3897059,
         10039774,
         3896033,
         23350151,
         24150543,
         23997798,
         22438418,
         15919505,
         21402007,
         20435258,
         21352097,
         20735483,
         1412933,
         21357599,
         21352185,
         20493453,
         22428506,
         20435284,
         20494115,
         7929215,
         346279,
         17059028,
         14922771,
         17082155,
         20274287,
         19858464,
         20265507,
         21609805,
         22047837,
         8039683,
         3918664,
         8243996,
         8922813,
         20274387,
         20295449,
         20196316,
         22536088,
         362083,
         8317011,
         8284834,
         8914957,
         14959443,
         2544757,
         8240980,
         22559698,
         22226750,
         8287544,
         8284864,
         1528165,
         9773421,
         17030748,
         1000901,
         17875239,
         1327179,
         17881806,
         17906171,
         9769464,
         2888700,
         3232257,
         3253649,
         18278757,
         3251699,
         917401,
         1312569,
         1333318,
         17896331,
         916523,
         5412161,
         5411797,
         10682344,
         23185037,
         3907607,
         10771996,
         23198662,
         23198354,
         23198490,
         23589104,
         23387469,
         22977286,
         23598143,
         23513354,
         23624914,
         23573444,
         24479267,
         23533481,
         23233057,
         24177529,
         22988807,
         23251689,
         23608924,
         23005225,
         23284675,
         23630536,
         4368894,
         12320705,
         22949983,
         22913036,
         4222526,
         12421177,
         22966476,
         24310417,
         12620920,
         4331257,
         4315128,
         7186652,
         12615222,
         12439817,
         22914974,
         23198686,
         11303910,
         20594352,
         8935230,
         10787024,
         23335616,
         11281510,
         23196464,
         23287859,
         10787142,
         11179211,
         23753746,
         7915709,
         23737995,
         24026308,
         24072907,
         23824341,
         23822105,
         23671337,
         23671309,
         23688870,
         23673649,
         23822229,
         23438159,
         23681451,
         23672921,
         23672885,
         24207735,
         23720045,
         23671521,
         23787091,
         24013729,
         1253434,
         5312866,
         1253380,
         3199208,
         10273928,
         10089334,
         3199234,
         4875297,
         3522133,
         11976913,
         10092650,
         4877491,
         11981059,
         11975499,
         24287762,
         23743942,
         24423329,
         24383499,
         23442137,
         23053605,
         24275509,
         23839156,
         23081904,
         23081144,
         23081654,
         23081682,
         24287082,
         23442985,
         23082132,
         23081918,
         23081648,
         24242137,
         23081338,
         23082478,
         23081068,
         23081816,
         23865072,
         23080960,
         12828432,
         24432335,
         12792773,
         12794017,
         18353277,
         5336903,
         24469910,
         22106559,
         24432299,
         24432351,
         12889889,
         12830978,
         12813075,
         12883298,
         3414090,
         24432481,
         18346893,
         17495565,
         18328922,
         23123703,
         12882722,
         15984679,
         23131434,
         12830296,
         2967074,
         24432493,
         24432227,
         23131092,
         23124149,
         24432257,
         18329668,
         12803338,
         4269868,
         18299838,
         12864592,
         18354103,
         4894037,
         23350111,
         23316516,
         23316844,
         23350559,
         24043263,
         23361893,
         11178943,
         20594432,
         22822804,
         11212154,
         4908522,
         20267045,
         10693375,
         10407362)
